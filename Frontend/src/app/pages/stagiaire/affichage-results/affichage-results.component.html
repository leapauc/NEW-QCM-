<br />
<br />
<div class="center">
  <h1>Affichage des résultats par tentative</h1>
  <br /><br />
  <p>
    Permet de consulter la liste des tentatives et visualiser les réponses
    données.
  </p>
  <p><i>Continue à pratiquer pour améliorer tes statistiques !</i></p>
  <br />
  <!-- Search bar -->
  <app-search-bar
    placeholder="Rechercher une question..."
    [(value)]="searchTerm"
    (valueChange)="applyFilter()"
  ></app-search-bar>
  <!-- Spinner pendant le chargement -->
  <div *ngIf="isLoading" class="text-center p-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
  </div>
  <!-- Message si aucune tentative en BDD -->
  <div
    *ngIf="!isLoading && attempts.length === 0"
    class="alert alert-warning text-center"
  >
    Vous n'avez aucune tentative enregistrée.
  </div>
  <!-- Message si aucun résultat après recherche -->
  <div
    *ngIf="!isLoading && attempts.length > 0 && filteredAttempts.length === 0"
    class="alert alert-info text-center"
  >
    Aucun résultat ne correspond à votre recherche.
  </div>
  <!-- Tableau des tentatives : uniquement si chargé et tentatives présentes -->
  <div
    class="table-responsive-custom"
    *ngIf="!isLoading && filteredAttempts.length > 0"
  >
    <table class="table table-striped">
      <thead>
        <tr>
          <th></th>
          <th>Nom du QCM</th>
          <th>Score</th>
          <th>Progression</th>
          <th>Fin</th>
          <th>Durée</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let attempt of paginatedAttempts">
          <td>
            <i
              class="bi bi-eye text-success fs-5"
              (click)="viewAttempt(attempt.id_attempt)"
            ></i>
          </td>
          <td>{{ attempt.title }}</td>
          <td style="width: 200px">
            <div class="position-relative" style="height: 20px">
              <div class="progress h-100">
                <div
                  class="progress-bar"
                  role="progressbar"
                  [ngStyle]="{
                    width: attempt.score + '%',
                    backgroundColor: getCompletionColor(attempt.score)
                  }"
                  [attr.aria-valuenow]="attempt.score"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <span
                class="position-absolute top-50 start-50 translate-middle fw-bold"
                style="color: black"
              >
                {{ attempt.score | number : "1.0-0" }}%
              </span>
            </div>
          </td>
          <td>
            <div class="position-relative" style="height: 20px">
              <div class="progress h-100">
                <div
                  class="progress-bar"
                  role="progressbar"
                  [ngStyle]="{
                    width: attempt.completed + '%',
                    backgroundColor: getCompletionColor(attempt.completed)
                  }"
                  [attr.aria-valuenow]="attempt.completed"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>

              <span
                class="position-absolute top-50 start-50 translate-middle fw-bold"
                style="color: black"
              >
                {{ attempt.completed | number : "1.0-0" }}%
              </span>
            </div>
          </td>
          <td>{{ attempt.started_at | date : "short" }}</td>
          <td *ngIf="attempt.duration.minutes">
            {{ attempt.duration.minutes }} min {{ attempt.duration.seconds }} s
          </td>
          <td *ngIf="!attempt.duration.minutes">
            {{ attempt.duration.seconds }} s
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <app-pagination
    *ngIf="filteredAttempts.length"
    [items]="filteredAttempts"
    [pageSize]="10"
    (pageChange)="paginatedAttempts = $event"
  >
  </app-pagination>
</div>

<!-- Modal -->
<div
  class="modal fade"
  id="attemptModal"
  tabindex="-1"
  aria-labelledby="attemptModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content p-3">
      <div class="modal-body" *ngIf="selectedAttemptQuestions.length">
        <h3>Questionnaire</h3>

        <div
          *ngFor="let q of selectedAttemptQuestions; let qIndex = index"
          class="mb-3"
        >
          <p>
            <b>{{ q.question }}</b>
          </p>
          <li
            class="list-group-item d-flex align-items-center"
            *ngFor="let resp of q.responses"
          >
            <input
              type="{{ q.type === 'single' ? 'radio' : 'checkbox' }}"
              [name]="'question' + qIndex"
              [checked]="resp.selected"
              disabled
              class="me-2"
            />
            {{ resp.response }}
          </li>
        </div>

        <button type="button" class="btn btn-primary" (click)="closeModal()">
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>
